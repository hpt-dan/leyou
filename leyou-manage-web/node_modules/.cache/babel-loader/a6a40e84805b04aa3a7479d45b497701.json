{"remainingRequest":"C:\\develop\\idea-projects\\leyou-manage-web\\node_modules\\babel-loader\\lib\\index.js!C:\\develop\\idea-projects\\leyou-manage-web\\node_modules\\vuetify-loader\\lib\\loader.js!C:\\develop\\idea-projects\\leyou-manage-web\\node_modules\\cache-loader\\dist\\cjs.js??ref--0-0!C:\\develop\\idea-projects\\leyou-manage-web\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!C:\\develop\\idea-projects\\leyou-manage-web\\src\\views\\item\\GoodsForm.vue?vue&type=script&lang=js&","dependencies":[{"path":"C:\\develop\\idea-projects\\leyou-manage-web\\src\\views\\item\\GoodsForm.vue","mtime":1552990870508},{"path":"C:\\develop\\idea-projects\\leyou-manage-web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\develop\\idea-projects\\leyou-manage-web\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"C:\\develop\\idea-projects\\leyou-manage-web\\node_modules\\vuetify-loader\\lib\\loader.js","mtime":1549812933000},{"path":"C:\\develop\\idea-projects\\leyou-manage-web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\develop\\idea-projects\\leyou-manage-web\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["import _Object$keys from \"C:\\\\develop\\\\idea-projects\\\\leyou-manage-web\\\\node_modules\\\\@babel\\\\runtime-corejs2/core-js/object/keys\";\nimport _Map from \"C:\\\\develop\\\\idea-projects\\\\leyou-manage-web\\\\node_modules\\\\@babel\\\\runtime-corejs2/core-js/map\";\nimport \"core-js/modules/es6.regexp.split\";\nimport _Object$assign from \"C:\\\\develop\\\\idea-projects\\\\leyou-manage-web\\\\node_modules\\\\@babel\\\\runtime-corejs2/core-js/object/assign\";\nimport _JSON$stringify from \"C:\\\\develop\\\\idea-projects\\\\leyou-manage-web\\\\node_modules\\\\@babel\\\\runtime-corejs2/core-js/json/stringify\";\nimport _Object$values from \"C:\\\\develop\\\\idea-projects\\\\leyou-manage-web\\\\node_modules\\\\@babel\\\\runtime-corejs2/core-js/object/values\";\nimport \"core-js/modules/es6.function.name\";\nimport \"core-js/modules/web.dom.iterable\";\nimport _objectWithoutProperties from \"C:\\\\develop\\\\idea-projects\\\\leyou-manage-web\\\\node_modules\\\\@babel\\\\runtime-corejs2/helpers/esm/objectWithoutProperties\";\nimport _slicedToArray from \"C:\\\\develop\\\\idea-projects\\\\leyou-manage-web\\\\node_modules\\\\@babel\\\\runtime-corejs2/helpers/esm/slicedToArray\";\nimport \"core-js/modules/es6.number.constructor\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nexport default {\n  name: \"goods-form\",\n  props: {\n    oldGoods: {\n      type: Object\n    },\n    isEdit: {\n      type: Boolean,\n      default: false\n    },\n    step: {\n      type: Number,\n      default: 1\n    }\n  },\n  data: function data() {\n    return {\n      valid: false,\n      goods: {\n        categories: [],\n        // 商品分类信息\n        brandId: 0,\n        // 品牌id信息\n        name: \"\",\n        // 标题\n        subTitle: \"\",\n        // 子标题\n        spuDetail: {\n          packingList: \"\",\n          // 包装列表\n          afterService: \"\",\n          // 售后服务\n          description: \"\" // 商品描述\n\n        }\n      },\n      brandOptions: [],\n      // 品牌列表\n      specs: [],\n      // 规格参数的模板\n      specialSpecs: [] // 特有规格参数模板\n\n    };\n  },\n  methods: {\n    submit: function submit() {\n      var _this = this;\n\n      // 表单校验。\n      if (!this.$refs.basic.validate) {\n        this.$message.error(\"请先完成表单内容！\");\n      } // 先处理goods，用结构表达式接收,除了categories外，都接收到goodsParams中\n\n\n      var _this$goods = this.goods,\n          _this$goods$categorie = _slicedToArray(_this$goods.categories, 3),\n          cid1 = _this$goods$categorie[0].id,\n          cid2 = _this$goods$categorie[1].id,\n          cid3 = _this$goods$categorie[2].id,\n          goodsParams = _objectWithoutProperties(_this$goods, [\"categories\"]); // 处理规格参数\n\n\n      var specs = {};\n      this.specs.forEach(function (_ref) {\n        var id = _ref.id,\n            v = _ref.v;\n        specs[id] = v;\n      }); // 处理特有规格参数模板\n\n      var specTemplate = {};\n      this.specialSpecs.forEach(function (_ref2) {\n        var id = _ref2.id,\n            options = _ref2.options;\n        specTemplate[id] = options;\n      }); // 处理sku\n\n      var skus = this.skus.filter(function (s) {\n        return s.enable;\n      }).map(function (_ref3) {\n        var price = _ref3.price,\n            stock = _ref3.stock,\n            enable = _ref3.enable,\n            images = _ref3.images,\n            indexes = _ref3.indexes,\n            rest = _objectWithoutProperties(_ref3, [\"price\", \"stock\", \"enable\", \"images\", \"indexes\"]);\n\n        // 标题，在spu的name基础上，拼接特有规格属性值\n        var title = goodsParams.name + \" \" + _Object$values(rest).map(function (v) {\n          return v.v;\n        }).join(\" \");\n\n        var obj = {};\n\n        _Object$values(rest).forEach(function (v) {\n          obj[v.id] = v.v;\n        });\n\n        return {\n          price: _this.$format(price),\n          // 价格需要格式化\n          stock: stock,\n          indexes: indexes,\n          enable: enable,\n          title: title,\n          // 基本属性\n          images: images ? images.join(\",\") : '',\n          // 图片\n          ownSpec: _JSON$stringify(obj) // 特有规格参数\n\n        };\n      });\n\n      _Object$assign(goodsParams, {\n        cid1: cid1,\n        cid2: cid2,\n        cid3: cid3,\n        // 商品分类\n        skus: skus // sku列表\n\n      });\n\n      goodsParams.spuDetail.genericSpec = _JSON$stringify(specs);\n      goodsParams.spuDetail.specialSpec = _JSON$stringify(specTemplate);\n      this.$http({\n        method: this.isEdit ? \"put\" : \"post\",\n        url: \"/item/goods\",\n        data: goodsParams\n      }).then(function () {\n        // 成功，关闭窗口\n        _this.$emit(\"close\"); // 提示成功\n\n\n        _this.$message.success(\"保存成功了\");\n      }).catch(function () {\n        _this.$message.error(\"保存失败！\");\n      });\n    }\n  },\n  watch: {\n    oldGoods: {\n      deep: true,\n      handler: function handler(val) {\n        if (!this.isEdit) {\n          _Object$assign(this.goods, {\n            categories: null,\n            // 商品分类信息\n            brandId: 0,\n            // 品牌id信息\n            name: \"\",\n            // 标题\n            subTitle: \"\",\n            // 子标题\n            spuDetail: {\n              packingList: \"\",\n              // 包装列表\n              afterService: \"\",\n              // 售后服务\n              description: \"\" // 商品描述\n\n            }\n          });\n\n          this.specs = [];\n          this.specialSpecs = [];\n        } else {\n          this.goods = Object.deepCopy(val); // 先得到分类名称\n\n          var names = val.categoryName.split(\"/\");\n          delete this.goods.categoryName;\n          delete this.goods.brandName;\n          delete this.goods.createTime;\n          delete this.goods.saleable; // 组织商品分类数据\n\n          this.goods.categories = [{\n            id: val.cid1,\n            name: names[0]\n          }, {\n            id: val.cid2,\n            name: names[1]\n          }, {\n            id: val.cid3,\n            name: names[2]\n          }]; // 将skus处理成map\n\n          var skuMap = new _Map();\n          this.goods.skus.forEach(function (s) {\n            s.enable = true;\n            skuMap.set(s.indexes, s);\n          });\n          this.goods.skus = skuMap;\n        }\n      }\n    },\n    \"goods.categories\": {\n      deep: true,\n      handler: function handler(val) {\n        var _this2 = this;\n\n        // 判断商品分类是否存在，存在才查询\n        if (val && val.length > 0) {\n          // 根据分类查询品牌\n          this.$http.get(\"/item/brand/of/category?id=\" + this.goods.categories[2].id).then(function (_ref4) {\n            var data = _ref4.data;\n            _this2.brandOptions = data;\n          }); // 根据分类查询规格参数\n\n          this.$http.get(\"/item/spec/params?cid=\" + this.goods.categories[2].id).then(function (_ref5) {\n            var data = _ref5.data;\n            var specs = [];\n            var template = [];\n\n            if (_this2.isEdit) {\n              specs = JSON.parse(_this2.goods.spuDetail.genericSpec);\n              template = JSON.parse(_this2.goods.spuDetail.specialSpec);\n            } // 对特有规格进行筛选\n\n\n            var arr1 = [];\n            var arr2 = [];\n            data.forEach(function (_ref6) {\n              var id = _ref6.id,\n                  name = _ref6.name,\n                  generic = _ref6.generic,\n                  numeric = _ref6.numeric,\n                  unit = _ref6.unit;\n\n              if (generic) {\n                var o = {\n                  id: id,\n                  name: name,\n                  numeric: numeric,\n                  unit: unit\n                };\n\n                if (_this2.isEdit) {\n                  o.v = specs[id];\n                }\n\n                arr1.push(o);\n              } else {\n                var _o = {\n                  id: id,\n                  name: name,\n                  options: []\n                };\n\n                if (_this2.isEdit) {\n                  _o.options = template[id];\n                }\n\n                arr2.push(_o);\n              }\n            });\n            _this2.specs = arr1; // 通用规格\n\n            _this2.specialSpecs = arr2; // 特有规格\n          });\n        }\n      }\n    }\n  },\n  computed: {\n    skus: function skus() {\n      var _this3 = this;\n\n      // 过滤掉用户没有填写数据的规格参数\n      var arr = this.specialSpecs.filter(function (s) {\n        return s.options.length > 0;\n      }); // 通过reduce进行累加笛卡尔积\n\n      return arr.reduce(function (last, spec, index) {\n        var result = [];\n        last.forEach(function (o) {\n          spec.options.forEach(function (option, i) {\n            var obj = JSON.parse(_JSON$stringify(o));\n            obj[spec.name] = {\n              v: option,\n              id: spec.id\n            };\n            obj.indexes = (obj.indexes || '') + '_' + i;\n\n            if (index === arr.length - 1) {\n              obj.indexes = obj.indexes.substring(1); // 如果发现是最后一组，则添加价格、库存等字段\n\n              _Object$assign(obj, {\n                price: 0,\n                stock: 0,\n                enable: false,\n                images: []\n              });\n\n              if (_this3.isEdit) {\n                // 如果是编辑，则回填sku信息\n                var sku = _this3.goods.skus.get(obj.indexes);\n\n                if (sku != null) {\n                  var price = sku.price,\n                      stock = sku.stock,\n                      enable = sku.enable,\n                      images = sku.images;\n\n                  _Object$assign(obj, {\n                    price: _this3.$format(price),\n                    stock: stock,\n                    enable: enable,\n                    images: images ? images.split(\",\") : []\n                  });\n                }\n              }\n            }\n\n            result.push(obj);\n          });\n        });\n        return result;\n      }, [{}]);\n    },\n    headers: function headers() {\n      if (this.skus.length <= 0) {\n        return [];\n      }\n\n      var headers = [];\n\n      _Object$keys(this.skus[0]).forEach(function (k) {\n        var value = k;\n\n        if (k === \"price\") {\n          // enable，表头要翻译成“价格”\n          k = \"价格\";\n        } else if (k === \"stock\") {\n          // enable，表头要翻译成“库存”\n          k = \"库存\";\n        } else if (k === \"enable\") {\n          // enable，表头要翻译成“是否启用”\n          k = \"是否启用\";\n        } else if (k === \"images\" || k === 'indexes') {\n          // 图片和索引不在表格中展示\n          return;\n        }\n\n        headers.push({\n          text: k,\n          align: \"center\",\n          sortable: false,\n          value: value\n        });\n      });\n\n      return headers;\n    }\n  }\n};",{"version":3,"sources":["GoodsForm.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <v-stepper v-model=\"step\">\n    <v-stepper-header>\n      <v-stepper-step :complete=\"step > 1\" step=\"1\">基本信息</v-stepper-step>\n      <v-divider/>\n      <v-stepper-step :complete=\"step > 2\" step=\"2\">商品描述</v-stepper-step>\n      <v-divider/>\n      <v-stepper-step :complete=\"step > 3\" step=\"3\">规格参数</v-stepper-step>\n      <v-divider/>\n      <v-stepper-step step=\"4\">SKU属性</v-stepper-step>\n    </v-stepper-header>\n    <v-stepper-items>\n      <!--1、基本信息-->\n      <v-stepper-content step=\"1\">\n        <v-flex class=\"xs10 mx-auto\">\n          <v-form v-model=\"valid\" ref=\"basic\">\n            <v-layout row>\n              <v-flex xs5>\n                <!--商品分类-->\n                <v-cascader\n                  url=\"/item/category/of/parent\"\n                  required\n                  showAllLevels\n                  v-model=\"goods.categories\"\n                  label=\"请选择商品分类\"/>\n              </v-flex>\n              <v-spacer/>\n              <v-flex xs5>\n                <!--品牌-->\n                <v-autocomplete\n                  :items=\"brandOptions\"\n                  item-text=\"name\"\n                  item-value=\"id\"\n                  label=\"所属品牌\"\n                  v-model=\"goods.brandId\"\n                  required\n                  autocomplete\n                  clearable\n                  dense chips\n                  :rules=\"[v => !!v || '品牌不能为空']\"\n                >\n                  <template slot=\"selection\" slot-scope=\"data\">\n                    <v-chip small>{{ data.item.name}}</v-chip>\n                  </template>\n                </v-autocomplete>\n              </v-flex>\n            </v-layout>\n            <v-text-field label=\"商品名称\" v-model=\"goods.name\" :counter=\"200\" required :rules=\"[v => !!v || '商品标题不能为空']\" hide-details/>\n            <v-text-field label=\"商品卖点（副标题）\" v-model=\"goods.subTitle\" :counter=\"200\" hide-details/>\n            <v-textarea label=\"包装清单\" v-model=\"goods.spuDetail.packingList\" :counter=\"1000\" :rows=\"3\" hide-details/>\n            <v-textarea label=\"售后服务\" v-model=\"goods.spuDetail.afterService\" :counter=\"1000\" :rows=\"3\" hide-details/>\n          </v-form>\n        </v-flex>\n      </v-stepper-content>\n      <!--2、商品描述-->\n      <v-stepper-content step=\"2\">\n        <v-editor v-model=\"goods.spuDetail.description\" url=\"/upload/signature\" needSignature/>\n      </v-stepper-content>\n      <!--3、规格参数-->\n      <v-stepper-content step=\"3\">\n        <v-flex class=\"xs10 mx-auto px-3\">\n          <!--遍历整个规格参数-->\n          <v-card class=\"my-2\">\n            <v-container grid-list-md fluid>\n            <v-layout wrap row justify-space-between class=\"px-5\">\n              <v-flex xs12 sm5 v-for=\"param in specs\" :key=\"param.name\">\n                <v-text-field :label=\"param.name\" v-model=\"param.v\" :suffix=\"param.unit || ''\"\n                 />\n              </v-flex>\n            </v-layout>\n          </v-container>\n          </v-card>\n        </v-flex>\n      </v-stepper-content>\n      <!--4、SKU属性-->\n      <v-stepper-content step=\"4\">\n        <v-flex class=\"mx-auto\">\n          <!--遍历特有规格参数-->\n          <v-card flat v-for=\"spec in specialSpecs\" :key=\"spec.name\">\n            <!--特有参数的标题-->\n            <div class=\"subheading\">{{spec.name}}:</div>\n            <!--特有参数的待选项，需要判断是否有options，如果没有，展示文本框，让用户自己输入-->\n            <v-card-text class=\"px-5\">\n              <div v-for=\"i in spec.options.length+1\" :key=\"i\" class=\"layout row px-5\">\n                <v-text-field :placeholder=\"'新的' + spec.name + ':'\" class=\"flex xs10\" auto-grow\n                              v-model=\"spec.options[i-1]\" v-bind:value=\"i\" single-line hide-details/>\n\n                <v-btn @click=\"spec.options.splice(i-1,1)\" v-if=\"i <= spec.options.length\" icon>\n                  <i class=\"el-icon-delete\"/>\n                </v-btn>\n              </div>\n            </v-card-text>\n          </v-card>\n          <v-card class=\"elevation-0\">\n            <!--标题-->\n            <div class=\"subheading py-3\">SKU列表:</div>\n            <v-divider/>\n            <!--SKU表格，hide-actions因此分页等工具条-->\n            <v-data-table :items=\"skus\" :headers=\"headers\" hide-actions item-key=\"indexes\" class=\"elevation-0\">\n              <template slot=\"items\" slot-scope=\"props\">\n                <tr @click=\"props.expanded = !props.expanded\">\n                  <!--价格和库存展示为文本框-->\n                  <td v-for=\"(v,k) in props.item\" :key=\"k\" v-if=\"['price', 'stock'].includes(k)\"\n                      class=\"text-xs-center\">\n                    <v-text-field single-line v-model=\"props.item[k]\" @click.stop=\"\"/>\n                  </td>\n                  <!--enable展示为checkbox-->\n                  <td class=\"text-xs-center\" v-else-if=\"k === 'enable'\">\n                    <v-checkbox v-model=\"props.item[k]\"/>\n                  </td>\n                  <!--indexes和images不展示，其它展示为普通文本-->\n                  <td class=\"text-xs-center\" v-else-if=\"k !== 'images' && k !== 'indexes'\">{{v.v}}</td>\n                </tr>\n              </template>\n              <!--点击表格后展开-->\n              <template slot=\"expand\" slot-scope=\"props\">\n                <v-card class=\"elevation-2 flex xs11 mx-auto my-2\">\n                  <!--图片上传组件-->\n                  <v-upload v-model=\"props.item.images\" url=\"/upload/image\"/>\n                </v-card>\n              </template>\n            </v-data-table>\n          </v-card>\n        </v-flex>\n        <!--提交按钮-->\n        <v-flex xs3 offset-xs9>\n          <v-btn color=\"info\" @click=\"submit\">保存商品信息</v-btn>\n        </v-flex>\n      </v-stepper-content>\n    </v-stepper-items>\n  </v-stepper>\n</template>\n\n<script>\nexport default {\n  name: \"goods-form\",\n  props: {\n    oldGoods: {\n      type: Object\n    },\n    isEdit: {\n      type: Boolean,\n      default: false\n    },\n    step: {\n      type: Number,\n      default: 1\n    }\n  },\n  data() {\n    return {\n      valid:false,\n      goods: {\n        categories: [], // 商品分类信息\n        brandId: 0, // 品牌id信息\n        name: \"\", // 标题\n        subTitle: \"\", // 子标题\n        spuDetail: {\n          packingList: \"\", // 包装列表\n          afterService: \"\", // 售后服务\n          description: \"\" // 商品描述\n        }\n      },\n      brandOptions: [], // 品牌列表\n      specs: [], // 规格参数的模板\n      specialSpecs: [] // 特有规格参数模板\n    };\n  },\n  methods: {\n    submit() {\n      // 表单校验。\n      if(!this.$refs.basic.validate){\n        this.$message.error(\"请先完成表单内容！\");\n      }\n      // 先处理goods，用结构表达式接收,除了categories外，都接收到goodsParams中\n      const {\n        categories: [{ id: cid1 }, { id: cid2 }, { id: cid3 }],\n        ...goodsParams\n      } = this.goods;\n      // 处理规格参数\n      const specs = {};\n      this.specs.forEach(({ id,v }) => {\n        specs[id] = v;\n      });\n      // 处理特有规格参数模板\n      const specTemplate = {};\n      this.specialSpecs.forEach(({ id, options }) => {\n        specTemplate[id] = options;\n      });\n      // 处理sku\n      const skus = this.skus\n        .filter(s => s.enable)\n        .map(({ price, stock, enable, images, indexes, ...rest }) => {\n          // 标题，在spu的name基础上，拼接特有规格属性值\n          const title = goodsParams.name + \" \" + Object.values(rest).map(v => v.v).join(\" \");\n          const obj = {};\n          Object.values(rest).forEach(v => {\n            obj[v.id] = v.v;\n          });\n          return {\n            price: this.$format(price), // 价格需要格式化\n            stock,\n            indexes,\n            enable,\n            title, // 基本属性\n            images: images ? images.join(\",\") : '', // 图片\n            ownSpec: JSON.stringify(obj) // 特有规格参数\n          };\n        });\n      Object.assign(goodsParams, {\n        cid1,\n        cid2,\n        cid3, // 商品分类\n        skus // sku列表\n      });\n      goodsParams.spuDetail.genericSpec = JSON.stringify(specs);\n      goodsParams.spuDetail.specialSpec = JSON.stringify(specTemplate);\n      this.$http({\n        method: this.isEdit ? \"put\" : \"post\",\n        url: \"/item/goods\",\n        data: goodsParams\n      })\n        .then(() => {\n          // 成功，关闭窗口\n          this.$emit(\"close\");\n          // 提示成功\n          this.$message.success(\"保存成功了\");\n        })\n        .catch(() => {\n          this.$message.error(\"保存失败！\");\n        });\n    }\n  },\n  watch: {\n    oldGoods: {\n      deep: true,\n      handler(val) {\n        if (!this.isEdit) {\n          Object.assign(this.goods, {\n            categories: null, // 商品分类信息\n            brandId: 0, // 品牌id信息\n            name: \"\", // 标题\n            subTitle: \"\", // 子标题\n            spuDetail: {\n              packingList: \"\", // 包装列表\n              afterService: \"\", // 售后服务\n              description: \"\" // 商品描述\n            }\n          });\n          this.specs = [];\n          this.specialSpecs = [];\n        } else {\n          this.goods = Object.deepCopy(val);\n\n          // 先得到分类名称\n          const names = val.categoryName.split(\"/\");\n          delete this.goods.categoryName;\n          delete this.goods.brandName;\n          delete this.goods.createTime;\n          delete this.goods.saleable;\n          // 组织商品分类数据\n          this.goods.categories = [\n            { id: val.cid1, name: names[0] },\n            { id: val.cid2, name: names[1] },\n            { id: val.cid3, name: names[2] }\n          ];\n\n          // 将skus处理成map\n          const skuMap = new Map();\n          this.goods.skus.forEach(s => {\n            s.enable = true;\n            skuMap.set(s.indexes, s);\n          });\n          this.goods.skus = skuMap;\n        }\n      }\n    },\n    \"goods.categories\": {\n      deep: true,\n      handler(val) {\n        // 判断商品分类是否存在，存在才查询\n        if (val && val.length > 0) {\n          // 根据分类查询品牌\n          this.$http\n            .get(\"/item/brand/of/category?id=\" + this.goods.categories[2].id)\n            .then(({ data }) => {\n              this.brandOptions = data;\n            });\n          // 根据分类查询规格参数\n          this.$http\n            .get(\"/item/spec/params?cid=\" + this.goods.categories[2].id)\n            .then(({ data }) => {\n              let specs = [];\n              let template = [];\n              if (this.isEdit){\n                specs = JSON.parse(this.goods.spuDetail.genericSpec);\n                template = JSON.parse(this.goods.spuDetail.specialSpec);\n              }\n              // 对特有规格进行筛选\n              const arr1 = [];\n              const arr2 = [];\n              data.forEach(({id, name,generic, numeric, unit }) => {\n                if(generic){\n                  const o = { id, name, numeric, unit};\n                  if(this.isEdit){\n                    o.v = specs[id];\n                  }\n                  arr1.push(o)\n                }else{\n                  const o = {id, name, options:[]};\n                  if(this.isEdit){\n                    o.options = template[id];\n                  }\n                  arr2.push(o)\n                }\n              });\n              this.specs = arr1;// 通用规格\n              this.specialSpecs = arr2;// 特有规格\n            });\n        }\n      }\n    }\n  },\n  computed: {\n    skus() {\n      // 过滤掉用户没有填写数据的规格参数\n      const arr = this.specialSpecs.filter(s => s.options.length > 0);\n      // 通过reduce进行累加笛卡尔积\n      return arr.reduce(\n        (last, spec, index) => {\n          const result = [];\n          last.forEach(o => {\n            spec.options.forEach((option, i) => {\n              const obj = JSON.parse(JSON.stringify(o));\n              obj[spec.name] = {v:option, id:spec.id};\n              obj.indexes = (obj.indexes || '') + '_' +  i\n              if (index === arr.length - 1) {\n                obj.indexes = obj.indexes.substring(1);\n                // 如果发现是最后一组，则添加价格、库存等字段\n                Object.assign(obj, {\n                  price: 0,\n                  stock: 0,\n                  enable: false,\n                  images: []\n                });\n                if (this.isEdit) {\n                  // 如果是编辑，则回填sku信息\n                  const sku = this.goods.skus.get(obj.indexes);\n                  if (sku != null) {\n                    const { price, stock, enable, images } = sku;\n                    Object.assign(obj, {\n                      price: this.$format(price),\n                      stock,\n                      enable,\n                      images: images ? images.split(\",\") : [],\n                    });\n                  }\n                }\n              }\n              result.push(obj);\n            });\n          });\n          return result;\n        },\n        [{}]\n      );\n    },\n    headers() {\n      if (this.skus.length <= 0) {\n        return [];\n      }\n      const headers = [];\n      Object.keys(this.skus[0]).forEach(k => {\n        let value = k;\n        if (k === \"price\") {\n          // enable，表头要翻译成“价格”\n          k = \"价格\";\n        } else if (k === \"stock\") {\n          // enable，表头要翻译成“库存”\n          k = \"库存\";\n        } else if (k === \"enable\") {\n          // enable，表头要翻译成“是否启用”\n          k = \"是否启用\";\n        } else if (k === \"images\" || k === 'indexes') {\n          // 图片和索引不在表格中展示\n          return;\n        }\n        headers.push({\n          text: k,\n          align: \"center\",\n          sortable: false,\n          value\n        });\n      });\n      return headers;\n    }\n  }\n};\n</script>\n\n<style scoped>\n</style>\n"],"sourceRoot":"src/views/item"}]}